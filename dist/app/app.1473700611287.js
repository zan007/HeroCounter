angular.module("activation",["ui.router"]).controller("activationCtrl",["$scope","$rootScope","$location","dataSource",function($scope,$rootScope,$location,dataSource){console.log("activationToken",$location.search().token),$rootScope.$on("app-ready",function(){console.log("activationCtrl"),dataSource.activateUserAccount($location.search().token)})}]),$script.ready("angular",function(){angular.module("heroCounter",["ui.router","ngAnimate","ngMessages","register","login","creatures","profile","creatureProfile","activation","settings","userManager","data.dataSource","ngTouch","ngEnter","constants","timer","timeUtils","userAuthService","radialProgressService","socketFactory","notificationService","utils.fastFilter","ngCookies","hcLocales","pikaday","controls.hcPrettyTime","controls.hcPrettyDayHour","controls.hcEventsTimeline","controls.hcValidationPattern","controls.hcEqual","controls.hcNotEqual","controls.hcUserHeroTile","controls.hcStripeChart","controls.hcCreatureBattleTile","controls.hcPieChart","controls.hcTimePicker","controls.hcCountdown","controls.hcTopChart","avatarService","ngImgCrop"]).config(["$httpProvider","$stateProvider","$urlRouterProvider",function($httpProvider,$stateProvider,$urlRouterProvider){$httpProvider.interceptors.push(function($q,$location,$window,$rootScope){return{response:function(response){return console.log("sukces"),response},responseError:function(response){return console.log("error"),401===response.status&&(console.log("401"),$rootScope.logout()),$q.reject(response)}}}),$urlRouterProvider.otherwise(function(){return"/creatures"}),$stateProvider.state("creatures",{url:"/creatures",templateUrl:"/creatures",authRequire:!0,params:{newsVisible:!0}}).state("login",{url:"/login",templateUrl:"/",authRequire:!1,params:{newsVisible:!1,destinationState:"",destinationParams:""}}).state("register",{url:"/register",templateUrl:"/register",authRequire:!1,params:{newsVisible:!1}}).state("settings",{url:"/settings",templateUrl:"/settings",authRequire:!0,params:{newsVisible:!1}}).state("userManager",{url:"/user-manager",templateUrl:"/user-manager",authRequire:!0,params:{newsVisible:!1}}).state("activation",{url:"/activation",templateUrl:"/activation",authRequire:!1,params:{newsVisible:!1}}).state("profile",{url:"/profile?userId",templateUrl:"/profile",authRequire:!0,params:{newsVisible:!0,userId:""}}).state("creatureProfile",{url:"/creatureProfile?creatureId",templateUrl:"/creature-profile",authRequire:!0,params:{newsVisible:!0,creatureId:""}})}]).config(["pikadayConfigProvider",function(pikaday){pikaday.setConfig({format:"YYYY-MM-DD"})}]).run(function($rootScope,userAuthService,$state,adminRestrictedStates,locales){$rootScope.appModules=locales.modules,$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState){if(void 0!==userAuthService.getIsLogged())if(!userAuthService.getIsLogged()||"register"!==toState.name&&"login"!==toState.name){var isAuthenticationRequired=toState.authRequire&&!userAuthService.getIsLogged();isAuthenticationRequired&&(event.preventDefault(),$state.go("login",{destinationState:toState.name,destinationParams:toParams}))}else event.preventDefault(),$state.go(fromState);var isPersonalDataReady=$rootScope.model&&$rootScope.model.personalData;adminRestrictedStates[toState.name]&&isPersonalDataReady&&!$rootScope.model.personalData.isAdministrator&&$state.go(fromState.name||"login")})}).constant("appStates",{"true":[{reference:"creatures",selected:!0},{reference:"settings",selected:!1}],"false":[{reference:"login",selected:!0},{reference:"register",selected:!1}]}).constant("adminRestrictedStates",{userManager:!0}).controller("AppCtrl",["$rootScope","$scope","dataSource","userAuthService","$state","appStates","notificationService","$stateParams","socketFactory","defaultAvatar","$window","locales",function($rootScope,$scope,dataSource,userAuthService,$state,appStates,notificationService,$stateParams,socketFactory,defaultAvatar,$window,locales){dataSource.getLanguage().then(function(data){$scope.activeLang=data}),userAuthService.init(),$rootScope.showLogout=!1,$scope.stateParams=$stateParams,$scope.defaultAvatarLink=defaultAvatar.link,$rootScope.locales=locales;var createSocketEventHandlers=function(){socketFactory.getSocket().then(function(socket){socket.on("hello",function(){console.log("udalo sie hello")}),socket.on("creaturesUpdated",function(data){console.log("zupdatowana lista ",data),dataSource.updateCreatures(data.creatures),notificationService.showInfoNotification("Creatures list updated")}),socket.on("eventsUpdated",function(data){console.log("nowy event",data),dataSource.addEvent(data),notificationService.showInfoNotification("Events list updated")})})};$rootScope.$on("app-ready",function(){$rootScope.states=appStates[userAuthService.getIsLogged()],userAuthService.getIsLogged()&&($rootScope.showLogout=!0,dataSource.init(),socketFactory.initializeSocket(),createSocketEventHandlers()),$state.reload(!0)}),$rootScope.$on("auth-login-success",function(){dataSource.init(),socketFactory.initializeSocket(),createSocketEventHandlers(),$rootScope.showLogout=!0}),$rootScope.$on("dataSource.ready",function(){$scope.personalData=$rootScope.model.personalData,$scope.events=$rootScope.model.events}),$scope.btnClick=!1,$rootScope.logout=function(){userAuthService.logout().then(function(){$rootScope.states=appStates[userAuthService.getIsLogged()],$rootScope.model={},socketFactory.disconnect(),$state.go($rootScope.states[0].reference)})},$scope.setLanguage=function(lang){lang!==$scope.activeLang&&dataSource.setLanguage(lang).then(function(){$window.location.reload()})}}])}),angular.module("constants",[]).constant("defaultAvatar",{link:"http://res.cloudinary.com/hero-counter/image/upload/v1465058452/default-avatar_lcdclq.png"}),angular.module("appAnimations",[]).animation(".list-out",["$window",function($window){return{start:function(element,done){TweenMax.set(element,{position:"relative"});var duration=1;TweenMax.to(element,1,{opacity:0,width:0}),$window.setTimeout(done,1e3*duration)}}}]).animation(".list-in",["$window",function($window){return{setup:function(element){TweenMax.set(element,{opacity:0,width:0})},start:function(element,done){var duration=1;TweenMax.to(element,duration,{opacity:1,width:210}),$window.setTimeout(done,1e3*duration)}}}]).animation(".list-move",["$window",function($window){return{start:function(element,done){var duration=1;TweenMax.to(element,duration,{opacity:1,width:210}),$window.setTimeout(done,1e3*duration)}}}]),angular.module("controls.hcCountdown",[]).directive("hcCountdown",["$timeout",function($timeout){return{scope:{timeToCountdown:"=hcCountdown"},templateUrl:"hc-countdown",replace:!0,link:function($scope){var startTimer=function(){$timeout(onTimeout,1e3)},onTimeout=function(){$scope.timeToCountdown=Math.floor($scope.timeToCountdown-1e3),$scope.seconds=Math.floor($scope.timeToCountdown/1e3%60),$scope.minutes=Math.floor($scope.timeToCountdown/6e4%60),$scope.hours=Math.floor($scope.timeToCountdown/36e5%24),$scope.days=Math.floor($scope.timeToCountdown/36e5/24),mytimeout=$timeout(onTimeout,1e3)};$scope.timeToCountdown&&startTimer()}}}]),angular.module("controls.hcCreatureBattleTile",[]).directive("hcCreatureBattleTile",["$rootScope","$window","radialProgressService",function($rootScope,$window,radialProgressService){return{scope:{type:"@",count:"=hcCreatureBattleTile",summaryCount:"="},replace:!0,restriction:"E",templateUrl:"hc-creature-battle-tile",link:function($scope,$elem){var countPercent=function(){var percent=Math.floor(100*$scope.count/$scope.summaryCount);return isNaN(percent)?"0%":percent+"%"},countAndRender=function(){$scope.summaryPercent=countPercent();var d3=$window.d3;d3.select($scope.radialChartElem[0]).select(".radial-svg")&&d3.select($scope.radialChartElem[0]).select(".radial-svg").remove(),radialProgressService.radialProgress($scope.radialChartElem[0],$scope.summaryCount).diameter(150).data([{type:"outer",value:$scope.count}]).render()};$scope.radialChartElem=$elem.find("g"),$scope.$watchGroup(["count","summaryCount"],function(){countAndRender()}),angular.element($window).bind("resize",function(){countAndRender(),$scope.$apply()})}}}]),angular.module("controls.hcCreatureTile",[]).directive("hcCreatureTile",["dataSource","$rootScope","notificationService","$timeout","$state",function(dataSource,$rootScope,notificationService,$timeout,$state){return{scope:{creature:"=hcCreatureTile"},replace:!0,restriction:"A",templateUrl:"hc-creature-tile",link:function($scope){$scope.showAdditionalActions=!1;$scope.reportedDate=moment().format("YYYY-MM-DD"),$scope.toggleAdditionalActions=function(){$scope.showAdditionalActions=!$scope.showAdditionalActions,$scope.reportedDate=moment().format("YYYY-MM-DD"),$scope.reportedTime=moment().valueOf(),console.log($scope.reportedTime,moment().valueOf())},$scope.reportDefeat=function(creature,time,date){var momentDate=moment(date),momentTime=moment(time);$scope.showLoadingIndicator=!0;var formattedDate=moment().set({year:momentDate.get("year"),month:momentDate.get("month"),day:momentDate.get("day"),hour:momentTime.get("hour"),minute:momentTime.get("minute"),second:momentTime.get("second"),millisecond:momentTime.get("millisecond")});dataSource.reportDefeat(creature,formattedDate.valueOf(),$rootScope.model.personalData.userToken).then(function(data){console.log("sukces raport ",data),$scope.showAdditionalActions=!1,$scope.showLoadingIndicator=!1},function(data){console.log("error raport ",data),$scope.showAdditionalActions=!1,$scope.showLoadingIndicator=!1})};var countTimeToResp=function(creature){var today=moment().valueOf(),maxRespDate=moment(creature.defeatedDate).add("h",creature.maxRespTime);if(moment(maxRespDate).isBefore(today))console.log("stare"),creature.timeToResp=null;else{var dateDifference=moment(maxRespDate).diff(moment(today));creature.timeToResp=dateDifference,$scope.$broadcast("timer-start")}return creature};$scope.goToCreatureProfile=function(id){id&&$state.go("creatureProfile",{creatureId:id})},$scope.creature=countTimeToResp($scope.creature),$scope.$watch("creature",function(newVal){$scope.creature=newVal,$scope.creature=countTimeToResp($scope.creature)})}}}]),angular.module("controls.hcEqual",[]).directive("hcEqual",function(){return{require:"ngModel",scope:{equalTo:"=hcEqual"},link:function($scope,iElm,iAttrs,ctrl){iAttrs.$observe("hcEqual",function(value){ctrl.$setValidity("hcEqual",!0),value&&ctrl.$validate()}),$scope.$watch("equalTo",function(newVal,oldVal){newVal!==oldVal&&ctrl.$validate()}),ctrl.$validators.hcEqual=function(value){var equalResult=!0,result=!0;return value&&(result=value===$scope.equalTo),ctrl.$setValidity("hcEqual",result),equalResult=equalResult&&result}}}}),angular.module("controls.hcEventsTimeline",[]).directive("hcEventsTimeline",["$state","dataSource","locales","$rootScope","timeUtils","locales","$timeout",function($state,dataSource,locales,$rootScope,timeUtils,locales){return{scope:{events:"=hcEventsTimeline",middle:"=middle"},replace:!0,restriction:"E",templateUrl:"hc-events-timeline",link:function($scope,$elem){console.log(locales.daysOfWeek.monday),$scope.showGoTopButton=!1,$rootScope.$on("dataSource.ready",function(){$scope.showLoadingIndicator=!1}),$scope.getDayName=function(date){return timeUtils.isToday(date)?locales.today:timeUtils.isYestarday(date)?locales.yesterday:moment(date).format("DD MM")},$scope.showDayLabel=function(event,index){if(0===index)return!0;var currentEventDay=new Date(event.battleDate||event.reportDate).getDay(),prevEventDay=new Date($scope.events[index-1].battleDate||$scope.events[index-1].reportDate).getDay();return currentEventDay!==prevEventDay},$scope.goToUserProfile=function(id){id&&$state.go("profile",{userId:id})},$scope.goToCreatureProfile=function(id){id&&$state.go("creatureProfile",{creatureId:id})},$scope.goToTop=function(){$elem.animate({scrollTop:0},500)},$scope.loadMoreEvents=function(daysBack){if($scope.events&&$scope.events.length>0){$scope.showLoadingIndicator=!0;var baseMoreEventsCounter=daysBack||1,lastEventDate=$scope.events[$scope.events.length-1].battleDate||$scope.events[$scope.events.length-1].reportDate;dataSource.getEvents(moment(lastEventDate).subtract(baseMoreEventsCounter,"days").valueOf(),moment(lastEventDate).subtract(1,"s").valueOf()).then(function(data){0===data.length?4>baseMoreEventsCounter&&($scope.loadMoreEvents(baseMoreEventsCounter+1),baseMoreEventsCounter++):baseMoreEventsCounter=1,$scope.showLoadingIndicator=!1})}},$elem.bind("scroll",function(){var element=$elem[0];element.scrollTop+element.offsetHeight>=element.scrollHeight&&$scope.loadMoreEvents(),$scope.showGoTopButton=$elem[0].scrollTop>20,$scope.$apply()})}}}]),angular.module("controls.hcNotEqual",[]).directive("hcNotEqual",function(){return{require:"ngModel",scope:{notEqualTo:"=hcNotEqual"},link:function($scope,iElm,iAttrs,ctrl){iAttrs.$observe("hcNotEqual",function(value){ctrl.$setValidity("hcNotEqual",!0),value&&ctrl.$validate()}),$scope.$watch("notEqualTo",function(newVal,oldVal){newVal!==oldVal&&ctrl.$validate()}),ctrl.$validators.hcNotEqual=function(value){var equalResult=!0,result=!0;return value&&(result=value!==$scope.notEqualTo),ctrl.$setValidity("hcNotEqual",result),equalResult=equalResult&&result}}}}),angular.module("controls.hcPieChart",[]).directive("hcPieChart",["$rootScope","$window",function($rootScope,$window){return{scope:{data:"=hcPieChart",nameField:"@",valueField:"@"},restriction:"E",replace:"true",templateUrl:"hc-pie-chart",link:function($scope,$elem){var valueField=$scope.valueField,nameField=$scope.nameField,pieChart=function(element,data,width){var d3=$window.d3,m=[10,10,10,10],w=width-m[1]-m[3],h=width-m[0]-m[2],r=h/2,component={};return component.render=function(){function angle(d){var a=90*(d.startAngle+d.endAngle)/Math.PI-90;return a>90?a-180:a}d3.select(element).select(".main-circle")&&d3.select(element).select(".main-circle").remove();var circle=d3.select(element).append("svg:svg").attr("class","main-circle"),vis=circle.data([data]).attr("width",w).attr("height",h).append("svg:g").attr("transform","translate("+r+","+r+")"),pie=d3.layout.pie().value(function(d){return d[valueField]}),arc=d3.svg.arc().outerRadius(r),arcs=vis.selectAll("g.slice").data(pie).enter().append("svg:g").attr("class","slice");arcs.append("svg:path").attr("d",function(d){return arc(d)}),arcs.append("svg:text").attr("transform",function(d){return d.innerRadius=w/7,d.outerRadius=r,"translate("+arc.centroid(d)+")rotate("+angle(d)+")"}).attr("fill","#fff").attr("class","chart-label").attr("text-anchor","middle").text(function(d,i){var currentElement=data[i];return 0!==currentElement[valueField]?currentElement[nameField]:""})},component},height=$elem.prop("offsetHeight");angular.element($window).bind("resize",function(){console.log("resize"),height=$elem.prop("offsetHeight"),pieChart($elem[0],$scope.data,height).render()}),$scope.$watch("data",function(newVal,oldVal){newVal!==oldVal&&pieChart($elem[0],$scope.data,height).render()})}}}]),angular.module("controls.hcPrettyDayHour",[]).directive("hcPrettyDayHour",["locales","timeUtils",function(){return{scope:{hoursIn:"=hcPrettyDayHour",fullNames:"@"},replace:!0,restriction:"E",templateUrl:"hc-pretty-day-hour",link:function($scope){$scope.$watch("hoursIn",function(){$scope.hoursIn&&($scope.days=Math.floor(($scope.hoursIn/24).toFixed(0)),$scope.hours=$scope.hoursIn%24)})}}}]),angular.module("controls.hcPrettyTime",[]).directive("hcPrettyTime",["locales","timeUtils",function(locales,timeUtils){return{scope:{date:"=hcPrettyTime",fullDate:"@",dayDescription:"@"},replace:!0,restriction:"E",templateUrl:"hc-pretty-time",link:function($scope){$scope.months=locales.months;var convertDate=function(){$scope.hours=moment($scope.date).hour(),$scope.minutes=moment($scope.date).minute(),$scope.dayDescription&&(timeUtils.isToday($scope.date)?($scope.isNear=!0,$scope.nearText=locales.today):timeUtils.isYestarday($scope.date)&&($scope.isNear=!0,$scope.nearText=locales.yesterday)),$scope.fullDate&&($scope.day=moment($scope.date).date(),$scope.month=moment($scope.date).month(),$scope.year=moment($scope.date).year())};$scope.$watch("date",function(){convertDate()},!0)}}}]),angular.module("controls.hcStripeChart",[]).directive("hcStripeChart",["$rootScope","$window",function($rootScope,$window){return{scope:{data:"=hcStripeChart",nameField:"@",valueField:"@",stepLine:"@",tooltipLabel:"@"},restriction:"E",replace:"true",templateUrl:"hc-stripe-chart",link:function($scope,$elem){var stripeChart=function(element,data,width,height){function wrap(text,width){text.each(function(){for(var word,text=d3.select(this),words=text.text().split(/\s+/).reverse(),line=[],lineNumber=0,lineHeight=1.1,y=text.attr("y"),dy=parseFloat(text.attr("dy")),tspan=text.text(null).append("tspan").attr("x",0).attr("y",y).attr("dy",dy+"em");word=words.pop();)line.push(word),tspan.text(line.join(" ")),tspan.node().getComputedTextLength()>width&&(line.pop(),tspan.text(line.join(" ")),line=[word],tspan=text.append("tspan").attr("x",0).attr("y",y).attr("dy",++lineNumber*lineHeight+dy+"em").text(word))})}var d3=window.d3,component={},nameField=$scope.nameField,valueField=$scope.valueField,m=[10,70,90,20],w=width-m[1]-m[3],h=height-m[0]-m[2],x=d3.scale.ordinal().rangePoints([0,w]),y=d3.scale.linear().range([h,0]),xAxis=d3.svg.axis().scale(x).orient("bottom").tickSize(-height),yAxis=d3.svg.axis().scale(y).ticks(2).orient("right").ticks(5).tickSize(-width),area=d3.svg.area().interpolate("ordinal").x(function(d){return x(d[nameField])}).y0(h).y1(function(d){return y(d[valueField])}),lineType=$scope.stepLine?"step-after":"interpolate",line=d3.svg.line().interpolate(lineType).x(function(d){return x(d[nameField])}).y(function(d){return y(d[valueField])});data.forEach(function(d){d[nameField]=d[nameField],d[valueField]=+d[valueField]});for(var total=0,i=0,len=data.length;len>i;i++)total+=data[i].valueField;return x.domain(data.map(function(d){return d[nameField]})),y.domain([0,d3.max(data,function(d){return d[valueField]})]).nice(),component.render=function(){d3.select("svg")&&d3.select("svg").remove();var svg=d3.select(element).append("svg:svg").attr("width",w+m[1]+m[3]).attr("height",h+m[0]+m[2]).append("svg:g").attr("transform","translate("+m[3]+","+m[0]+")");svg.append("svg:path").attr("class","area").attr("d",area(data)),svg.append("svg:g").attr("class","x axis").attr("transform","translate(40,"+(h+25)+")").call(xAxis).selectAll("text").call(wrap,x.rangeBand()).attr("transform","rotate(65)"),svg.append("svg:g").attr("class","y axis").attr("transform","translate("+(w+15)+",0)").call(yAxis),svg.selectAll("line.y").data(y.ticks(2)).enter().append("line").attr("x1",0).attr("x2",w).attr("y1",y).attr("y2",y).style("stroke","#000000").style("stroke-dasharray","5,5").style("stroke-opacity",.1),svg.append("svg:path").attr("class","line").attr("d",line(data));var tooltip=d3.select("body").append("div").attr("class","circle-tooltip");svg.selectAll("circle").data(data).enter().append("circle").attr("class","chart-circle").attr("cx",function(d){return x(d[nameField])}).attr("cy",function(d){return y(d[valueField])}).on("mouseover",function(d){return tooltip.text($scope.tooltipLabel+":"+d[valueField].toFixed(2)),tooltip.style("visibility","visible")}).on("mousemove",function(){return tooltip.style("top",d3.event.pageY-10+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return tooltip.style("visibility","hidden")})},component};angular.element($window).bind("resize",function(){console.log("resize");var width=$elem.prop("offsetWidth"),height=$elem.prop("offsetHeight");stripeChart($elem[0],$scope.data,width,height).render()}),console.log($scope.data);var width=$elem.prop("offsetWidth"),height=$elem.prop("offsetHeight");$scope.$watch("data",function(newVal,oldVal){console.log("data w pie chart",newVal,oldVal),newVal!==oldVal&&(console.log("stripe chart watch przy zmianie"),stripeChart($elem[0],$scope.data,width,height).render())})}}}]),angular.module("controls.hcTimePicker",[]).directive("hcTimePicker",function(){return{scope:{time:"=hcTimePicker"},replace:!0,restriction:"E",templateUrl:"hc-time-picker",link:function($scope){var date=moment($scope.time),updateTime=function(){$scope.time=moment({hour:$scope.hour,minute:$scope.minutes})};$scope.$watch("time",function(newVal){date=moment(newVal),$scope.hour=date.hours(),$scope.minutes=date.minutes()}),$scope.incrementHour=function(){$scope.hour++,$scope.hour>=24&&($scope.hour="00"),updateTime()},$scope.decrementHour=function(){$scope.hour--,$scope.hour<=0&&($scope.hour="23"),updateTime()},$scope.incrementMinutes=function(){$scope.minutes++,$scope.minutes>=60&&($scope.minutes="00"),updateTime()},$scope.decrementMinutes=function(){$scope.minutes--,$scope.minutes<=0&&($scope.minutes="59"),updateTime()},$scope.$watch("hour",function(newHour,oldHour){(newHour>23||0>newHour)&&($scope.hour=oldHour,updateTime())}),$scope.$watch("minutes",function(newMinutes,oldMinutes){(newMinutes>60||0>newMinutes)&&($scope.minutes=oldMinutes,updateTime())})}}}),angular.module("controls.hcTopChart",[]).directive("hcTopChart",["$rootScope","$window","$state",function($rootScope,$window,$state){return{scope:{topData:"=hcTopChart"},replace:!0,restriction:"E",templateUrl:"hc-top-chart",link:function($scope){$scope.goToUserProfile=function(id){id&&$state.go("profile",{userId:id})}}}}]),angular.module("controls.hcUserHeroTile",[]).directive("hcUserHeroTile",["$rootScope","$window","radialProgressService",function($rootScope,$window,radialProgressService){return{scope:{hero:"=hcUserHeroTile",stats:"="},replace:!0,restriction:"E",templateUrl:"hc-user-hero-tile",link:function($scope,$elem){var countPercent=function(){var percent=Math.floor(100*$scope.battleCount/$scope.stats.summaryBattles);return isNaN(percent)?"0%":percent+"%"},countAndRender=function(stats){for(var battles=stats.battles,i=0,len=battles.length;len>i;i++){var currentBattle=battles[i];currentBattle.heroId===$scope.hero.id&&($scope.battleCount=currentBattle.battleCount)}$scope.summaryPercent=countPercent();var d3=$window.d3;d3.select($scope.radialChartElem[0]).select(".radial-svg")&&d3.select($scope.radialChartElem[0]).select(".radial-svg").remove(),radialProgressService.radialProgress($scope.radialChartElem[0],$scope.stats.summaryBattles).diameter(150).data([{type:"outer",value:$scope.battleCount}]).render()};$scope.battleCount=0,$scope.radialChartElem=$elem.find("g"),$scope.$watch("stats",function(stats){countAndRender(stats)}),angular.element($window).bind("resize",function(){countAndRender($scope.stats),$scope.$apply()})}}}]),angular.module("controls.hcValidationPattern",[]).constant("validationPatterns",{TEXT:/^[a-zA-Z0-9]+$/,EMAIL:/^([^.@]+)(\.[^.@]+)*@([^.@]+\.)+[^.@]{2,6}$/,NUMBER:/^[0-9]*$/,EMAIL_CHARS:/^[a-zA-Z0-9_\-\.\@]+$/,PHONE_NUMBER:/^(?:\(?\+?48)?(?:[-\.\(\)\s]*(\d)){9}\)?/}).directive("hcValidationPattern",["validationPatterns",function(validationPatterns){var patternCache={},getRegExp=function(patternKey){var regExp=patternCache[patternKey];if(!regExp){var pattern=validationPatterns[patternKey];if(!pattern)return null;regExp=patternCache[patternKey]=new RegExp(pattern)}return regExp};return{require:"ngModel",link:function($scope,iElm,iAttrs,ctrl){var patternRegExps;iAttrs.$observe("hcValidationPattern",function(value){for(var i=0;patternRegExps&&i<patternRegExps.length;i++)ctrl.$setValidity("hcValidationPattern."+patternRegExps[i].patternKey,!0);value?(patternRegExps=value.split(",").map(function(patternKey){return{patternKey:patternKey,validator:getRegExp(patternKey)}}),ctrl.$validate()):patternRegExps=null}),ctrl.$validators.hcValidationPattern=function(value){if(!patternRegExps)return!0;for(var patternResult=!0,i=0;i<patternRegExps.length;i++){var result=patternRegExps[i].validator.test(value);ctrl.$setValidity("hcValidationPattern."+patternRegExps[i].patternKey,result),patternResult=patternResult&&result}return patternResult}}}}]),angular.module("ngEnter",[]).directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),angular.module("data.authentication",[]).factory("authentication",["$http","$q","$rootScope","$location","notificationService","locales","call",function($http,$q,$rootScope,$location,notificationService,locales,call){var initModel=function(){$rootScope.model={creatures:[],personalData:{},events:[],users:[]}};initModel();var authentication={register:function(registerData){return call({method:"POST",url:"/signup",data:{login:registerData.login,password:registerData.password,email:registerData.email,name:registerData.name}},function(){})},logg:function(credential){return call({method:"POST",url:"/login",data:{login:credential.login,password:credential.password}},function(){})},isLoggedIn:function(){var deferred=$q.defer();return $http.get("/isLoggedIn").success(function(user){user?deferred.resolve(user):deferred.reject()}),deferred.promise},logout:function(){return call({method:"GET",url:"/logout",data:{}},function(){initModel(),$rootScope.$broadcast("dataSource.ready")})},changePassword:function(user,oldPassword,newPassword){return call({method:"POST",url:"/changePassword",data:{userId:user.id,oldPassword:oldPassword,newPassword:newPassword}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})}};return authentication}]),angular.module("data.call",[]).factory("call",["$http","$q","$rootScope","$location","notificationService","locales",function($http,$q,$rootScope,$location,notificationService,locales){return function(httpData,responseFn){$rootScope.$broadcast("dataSource.start");var promise=$http(httpData).then(function(response){var result;return responseFn&&(result=responseFn(response.data,response.status,response.headers)),$rootScope.$broadcast("dataSource.stop"),result||response.data}).then(null,function(reason){return console.log(reason),reason.data.code&&notificationService.showErrorNotification(reason.data.code?locales.errorCodes[reason.data.code]:"",reason.data.persistence),$rootScope.$broadcast("dataSource.error"),$q.reject(reason)});return promise}}]),angular.module("data.context",[]).factory("context",["$http","$q","$rootScope","$location","notificationService","locales","call",function($http,$q,$rootScope,$location,notificationService,locales,call){var context={setLanguage:function(lang){return call({method:"POST",url:"/setLanguage",data:{lang:lang}})},getLanguage:function(){return call({method:"GET",url:"/getLanguage"})},init:function(){return call({method:"GET",url:"/init",data:{}},function(data){$rootScope.model.creatures=data.creatures,$rootScope.model.personalData=data.personalData,$rootScope.model.events=data.events,$rootScope.model.users=data.users,$rootScope.$broadcast("dataSource.ready")})}};return context}]),angular.module("data.creature",[]).factory("creature",["$http","$q","$rootScope","$location","notificationService","locales","call",function($http,$q,$rootScope,$location,notificationService,locales,call){var creature={defeatCreature:function(creature){return call({method:"POST",url:"/defeat",data:{creatureName:creature.name}},function(){})},reportDefeat:function(creature,date,reporterToken){return call({method:"POST",url:"/reportDefeat",data:{creature:creature,date:date,reporterToken:reporterToken}},function(data){console.log("report defeat",data)})},updateCreatures:function(creatures){for(var i=0,len=creatures.length;len>i;i++)for(var j=0,length=$rootScope.model.creatures.length;length>j;j++)if($rootScope.model.creatures[j].name===creatures[i].name){$rootScope.model.creatures[j]=creatures[i];break}$rootScope.$broadcast("dataSource.ready")},addEvent:function(event){for(var addIndex=0,i=0,len=$rootScope.model.events.length;len>i;i++){var currentEvent=$rootScope.model.events[i],eventToAddTimestamp=moment(event.battleDate||event.reportDate).valueOf(),currentEventTimestamp=moment(currentEvent.battleDate||currentEvent.reportDate).valueOf();if(eventToAddTimestamp>=currentEventTimestamp){addIndex=i;break}}$rootScope.model.events.splice(addIndex,0,event),$rootScope.$broadcast("dataSource.ready")},getCreatureProfile:function(creatureId){return call({method:"GET",url:"/creatureProfile",params:{creatureId:creatureId}},function(){})},getCreatureAnalyze:function(creatureId){return call({method:"GET",url:"/creatureAnalyze",params:{creatureId:creatureId}})},getEvents:function(fromTimestamp,toTimestamp){return call({method:"POST",url:"/getEvents",data:{fromTimestamp:fromTimestamp,toTimestamp:toTimestamp}},function(data){$rootScope.model.events=$rootScope.model.events.concat(data),$rootScope.$broadcast("dataSource.ready"),console.log("nowe eventy ",data)})}};return creature}]),angular.module("data.dataSource",["data.authentication","data.context","data.creature","data.user","data.call"]).factory("dataSource",["$http","$q","$rootScope","$location","notificationService","locales","authentication","context","creature","user",function($http,$q,$rootScope,$location,notificationService,locales,authentication,context,creature,user){var dataSource={},use=function(service){angular.extend(dataSource,service)};return use(authentication),use(context),use(creature),use(user),$rootScope.opened=!1,dataSource}]),angular.module("data.user",[]).factory("user",["$http","$q","$rootScope","$location","notificationService","locales","call",function($http,$q,$rootScope,$location,notificationService,locales,call){var user={getUserProfile:function(userId){return call({method:"GET",url:"/getUserProfile",params:{userId:userId}})},changeAvatar:function(userId,avatar){return call({method:"POST",url:"/changeAvatar",data:{userId:userId,avatar:avatar}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})},applyContactSettings:function(contactSettingsModel){return call({method:"POST",url:"/applySettings",data:{phoneNumber:contactSettingsModel.phone,phoneVisible:contactSettingsModel.phoneVisible,ggNumber:contactSettingsModel.gg,ggVisible:contactSettingsModel.ggVisible,name:contactSettingsModel.name,userId:contactSettingsModel.id}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})},getUsers:function(){return call({method:"POST",url:"/getUsers",data:{userToken:$rootScope.model.personalData.userToken}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},activateUserAccount:function(token){return call({method:"POST",url:"/activate",data:{token:token}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},acceptUserActivation:function(user){return call({method:"POST",url:"/acceptUserActivation",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},setAdministrator:function(user){return call({method:"POST",url:"/setAdministrator",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},setCommonUser:function(user){return call({method:"POST",url:"/setCommonUser",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},rejectUserActivation:function(user){return call({method:"POST",url:"/rejectUserActivation",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},changeEmail:function(user,oldEmailAddress,newEmailAddress){return call({method:"POST",url:"/changeEmail",data:{userId:user.id,oldEmail:oldEmailAddress,newEmail:newEmailAddress}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})}};return user}]),angular.module("creatureLvlFilter",[]).filter("creatureLvlFilter",function(){return function(input,lvlRange){if(!input)return input;
for(var output=[],from=lvlRange.minValue,to=lvlRange.maxValue,i=0;i<input.length;i++)currentItem=input[i],currentItem.lvl>=from&&currentItem.lvl<=to&&output.push(input[i]);return output}}),angular.module("creatureTypeFilter",[]).filter("creatureTypeFilter",function(){return function(input,type){if(!input)return input;for(var output=[],i=0;i<input.length;i++)currentItem=input[i],"titan"!==currentItem.type&&"event-titan"!==currentItem.type||!type.titan||output.push(input[i]),"hero"!==currentItem.type&&"event-hero"!==currentItem.type||!type.hero||output.push(input[i]);return output}}),angular.module("filters.creaturesFilter",["creatureTypeFilter","creatureLvlFilter","respTimeFilter","utils.fastFilter","creaturesQueryFilter","onlyWithKnownTimeFilter"]).factory("creaturesFilter",["$rootScope","fastFilter",function($rootScope,fastFilter){return fastFilter.create("onlyWithKnownTimeFilter:onlyWithKnownTime | creatureTypeFilter:creatureType | creatureLvlFilter:lvlRange | creaturesQueryFilter:queryInput | respTimeFilter:hoursToResp:onlyWithKnownTime",{creatureType:{titan:!0,hero:!0},lvlRange:{minValue:20,maxValue:320},hoursToResp:2,onlyWithKnownTime:!0})}]),angular.module("creaturesQueryFilter",[]).constant("localLetters",{"ą":"a","ć":"c","ę":"e","ł":"l","ń":"n","ó":"o","ś":"s","ź":"z"}).filter("creaturesQueryFilter",function(localLetters){var localLettersChain="ą|ć|ę|ł|ń|ó|ś|ź";return function(input,query){if(!input||!query)return input;for(var output=[],queryWithoutLocal=query.replace(new RegExp(localLettersChain,"gi"),function(matched){return localLetters[matched]}),i=0;i<input.length;i++)currentItem=input[i],(-1!=currentItem.name.toLowerCase().indexOf(query)||-1!=currentItem.name.toLowerCase().indexOf(queryWithoutLocal)||-1!=currentItem.name.indexOf(query)||-1!=currentItem.name.indexOf(queryWithoutLocal))&&output.push(input[i]);return output}}),angular.module("onlyWithKnownTimeFilter",[]).filter("onlyWithKnownTimeFilter",function(){return function(input,onlyWithKnownTime){if(!input)return input;for(var output=[],i=0;i<input.length;i++){var currentItem=input[i];onlyWithKnownTime?(currentItem.timeToResp||currentItem.lastSeenDate)&&output.push(input[i]):output.push(input[i])}return output}}),angular.module("respTimeFilter",[]).filter("respTimeFilter",function(){return function(input,hoursToResp,enabled){if(!input||!enabled)return input;for(var output=[],hoursToRespTimestamp=36e5*hoursToResp,i=0;i<input.length;i++){var currentItem=input[i];currentItem.timeToResp&&hoursToRespTimestamp>currentItem.timeToResp&&output.push(input[i])}return output}}),angular.module("avatarService",[]).factory("avatarService",["$q","notificationService",function($q,notificationService){return{uploadAvatar:function(){},readImageFile:function(file){var deferred=$q.defer();if(window.FileReader){file.size>4e6&&(notificationService.showErrorNotification("Error, photo exceeds max size limit."),deferred.reject()),file.type.match("image.*")||(notificationService.showErrorNotification("Error, file must be a photo."),deferred.reject());var reader=new FileReader;reader.onloadend=function(event){null!=event.target.error?(notificationService.showErrorNotification("Error, please try another photo."),deferred.reject()):deferred.resolve(reader.result)},reader.readAsDataURL(file)}else notificationService.showErrorNotification("Sorry, this browser doesn't support photo uploads."),deferred.reject();return deferred.promise}}}]),angular.module("notificationService",["ui-notification"]).config(function(NotificationProvider){NotificationProvider.setOptions({delay:2e3,startTop:20,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"left",positionY:"bottom"})}).factory("notificationService",["locales","Notification",function(locales,Notification){return{showInfoNotification:function(message,persistence){Notification.info({title:'<i class="icon-info-circled"></i><div class="subtitle">'+message+"</div>",delay:persistence?15e3:2e3})},showErrorNotification:function(message,persistence){var messageTitle='<i class="icon-error"></i><div class="subtitle">'+locales.error.header+"</div>";Notification.error({message:message,title:messageTitle,delay:persistence?15e3:2e3})},showSuccessNotification:function(message,persistence){Notification.success({title:'<i class="icon-success"></i><div class="subtitle">'+message+"</div>",delay:persistence?15e3:2e3})}}}]),angular.module("radialProgressService",[]).factory("radialProgressService",function(){return{radialProgress:function(parent,max){function drawBackground(group){var background=group.append("g").attr("class","component");s.arc.outer.endAngle(360*(Math.PI/180)),background.append("path").attr("transform","translate("+s.width/2+","+s.width/2+")").attr("d",s.arc.outer)}function drawArcs(svg,mainGroup){mainGroup.append("g").attr("class","arcs");svg.select(".arcs").selectAll(".arc").data(s.data,function(d){return d.type}).enter().append("path").attr("class",function(d){return"arc "+d.type+"-arc"}).attr("transform","translate("+s.width/2+","+s.height/2+")").attr("d",function(d){return s.arc[d.type]()}).each(function(d){var range=s.bound.max-s.bound.min,ratio=(d.value-s.bound.min)/range,endAngle=Math.min(360*ratio,360)*Math.PI/180;s.goal[d.type]=endAngle,d3.select(this).transition().duration(s.duration).attrTween("d",arcTween)})}function component(){d3.select(parent).each(function(){var svg=d3.select(this).append("svg"),mainGroup=svg.attr("class","radial-svg").append("g").attr("class","main-group").attr("transform","translate("+s.margin.left+","+s.margin.top+")");drawBackground(mainGroup),drawArcs(svg,mainGroup)})}function arcTween(d){var i=d3.interpolate(0,s.goal[d.type]);return function(t){return s.arc[d.type].endAngle(i(t))()}}function measure(){s.width=s.diameter-s.margin.right-s.margin.left-s.margin.top-s.margin.bottom,s.height=s.width;var halfw=s.width/2,_80w=.95*halfw,_20w=.05*halfw;s.arc.outer.outerRadius(halfw),s.arc.outer.innerRadius(_80w),s.arc.inner.outerRadius(_80w),s.arc.inner.innerRadius(_80w-_20w)}var d3=window.d3,s={duration:1e3,margin:{top:0,right:0,bottom:0,left:0},width:150,height:150,diameter:0,bound:{min:0,max:max>0?max:100},goal:{outer:3.14,inner:6.28},data:[{type:"outer",value:0},{type:"inner",value:0}],arc:{outer:d3.svg.arc().startAngle(0*(Math.PI/180)),inner:d3.svg.arc().startAngle(0*(Math.PI/180)).endAngle(0)}};return component.render=function(){return measure(),component(),component},component.data=function(_){return arguments.length?(s.data=_,component):s.data},component.margin=function(_){return arguments.length?(s.margin=_,component):s.margin},component.diameter=function(_){return arguments.length?(s.diameter=_,component):s.diameter},component.minValue=function(_){return arguments.length?(s.bound.min=_,component):s.bound.min},component.maxValue=function(_){return arguments.length?(s.bound.max=_,component):s.bound.max},component.duration=function(_){return arguments.length?(s.duration=_,component):s.duration},component}}}),angular.module("socketFactory",[]).factory("socketFactory",["$q","$rootScope","$timeout","userAuthService","$location",function($q,$rootScope,$timeout,userAuthService,$location){function getSocket(){return socket&&deferred.resolve(socket),deferred.promise}var socket="",deferred=$q.defer();return{initializeSocket:function(){socket=new io,socket=io.connect($location.protocol()+"://"+$location.host()+":"+$location.port()),deferred.resolve(socket)},disconnect:function(){socket.removeAllListeners()},getSocket:getSocket}}]),angular.module("userAuthService",[]).constant("AUTH_EVENTS",{sessionTimeout:"auth-session-timeout",loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",notAuthenticated:"auth-not-authenticated",authenticated:"auth-authenticated"}).factory("userAuthService",["$rootScope","dataSource","$http","$q","AUTH_EVENTS",function($rootScope,dataSource,$http,$q,AUTH_EVENTS){var self=this;this.isLogged;var setLogged=function(value){self.isLogged=value},getIsLogged=function(){return self.isLogged},getUserAuthData=function(){var deferred=$q.defer();return dataSource.isLoggedIn().then(function(data){data&&data.hasOwnProperty("password")?(setLogged(!0),console.log("serwis, ",data),$rootScope.$broadcast(AUTH_EVENTS.authenticated),deferred.resolve(data)):(setLogged(!1),$rootScope.$broadcast(AUTH_EVENTS.notAuthenticated),deferred.resolve())}),deferred.promise},init=function(){getUserAuthData().then(function(){$rootScope.$broadcast("app-ready")})},loggIn=function(login,password){var credentials={login:login,password:password},deferred=$q.defer();return dataSource.logg(credentials).then(function(data){setLogged(!0),$rootScope.$broadcast(AUTH_EVENTS.loginSuccess),deferred.resolve(data)},function(){deferred.reject(),$rootScope.$broadcast(AUTH_EVENTS.loginFailed)}),deferred.promise},logout=function(){var deferred=$q.defer();return dataSource.logout().then(function(data){console.log("logout service",data),setLogged(!1),$rootScope.$broadcast(AUTH_EVENTS.logoutSuccess),deferred.resolve()},function(){deferred.reject()}),deferred.promise},register=function(registerData){var deferred=$q.defer();return dataSource.register(registerData).then(function(){deferred.resolve()},function(){deferred.reject()}),deferred.promise};return{loggIn:loggIn,getIsLogged:getIsLogged,logout:logout,register:register,init:init,getUserAuthData:getUserAuthData,authEvents:AUTH_EVENTS,setLogged:setLogged}}]),angular.module("utils.fastFilter",[]).factory("fastFilter",["$filter","$rootScope",function($filter){return{create:function(filtersChain,initialFilterObj){function getFirstDirtyFilter(filterObj){var dirtyFilters=[];for(var param in filterObj)filterObj.hasOwnProperty(param)&&!angular.equals(filterObj[param],oldFilterObj[param])&&dirtyFilters.push(paramsMapping[param]);return dirtyFilters.length?filtersOrdered[Math.min.apply(Math,dirtyFilters)]:null}function runFiltersFromChain(chain,input,filterObj){if(0==chain.length)return input;var filter=filters[chain[0]];return filter.cached=input,runFiltersFromChain(chain.slice(1),filter.run(input,filterObj),filterObj)}for(var filterDescs=filtersChain.replace(/\s+/g,"").split("|"),filters=[],filtersOrdered=[],paramsMapping=[],i=0;i<filterDescs.length;i++){var filterMeta=filterDescs[i].split(":"),filterName=filterMeta[0],filterParams=filterMeta.slice(1);filtersOrdered[i]=filterName,filters[filterName]={name:filterName,params:filterParams,run:function(input,filterObj){for(var paramValues=[input],paramNames=this.params,i=0;i<paramNames.length;i++)paramValues[i+1]=filterObj[paramNames[i]];return $filter(this.name).apply(this,paramValues)},cached:void 0,order:i};for(var p=0;p<filterParams.length;p++)paramsMapping[filterParams[p]]=i}var oldInput=void 0,oldFilterObj=initialFilterObj,lastResult=void 0;return{filter:function(input,filterObj){if(!input)return input;var filterName=filtersOrdered[0];if(oldFilterObj&&input==oldInput&&(filterName=getFirstDirtyFilter(filterObj),!filterName))return lastResult;if(oldInput!=input)for(var key in filters)delete filters[key].cached;oldInput=input,oldFilterObj=angular.copy(filterObj);var filtersToExecute=filtersOrdered.slice(filters[filterName].order);if(filtersToExecute.length>0){var firstFilter=filters[filtersToExecute[0]];return lastResult=runFiltersFromChain(filtersToExecute,void 0===firstFilter.cached?input:firstFilter.cached,filterObj)}return input},get:function(){return angular.copy(oldFilterObj)}}}}}]),angular.module("timeUtils",[]).factory("timeUtils",["$q",function(){return{isToday:function(date){var diff=moment().diff(moment(date));return diff>0&&864e5>diff},isYestarday:function(date){var diff=moment().diff(moment(date));return diff>0&&diff>=864e5&&1728e5>diff}}}]),angular.module("creatures",["ngEnter","controls.hcCreatureTile","rzModule","filters.creaturesFilter"]).controller("creaturesCtrl",["$scope","$rootScope","dataSource","$http","creaturesFilter","$cookies","$cookieStore","$stateParams","$timeout","socketFactory","notificationService","call",function($scope,$rootScope,dataSource,$http,creaturesFilter,$cookies,$cookieStore,$stateParams,$timeout,socketFactory,notificationService,call){$scope.filteredCreatures={},$scope.filter=creaturesFilter.get(),$rootScope.$on("dataSource.ready",function(){$scope.creatures=$rootScope.model.creatures,$scope.filteredCreatures=creaturesFilter.filter(angular.copy($scope.creatures),$scope.filter),$timeout(function(){$scope.$broadcast("rzSliderForceRender")})}),$rootScope.model.creatures&&$rootScope.model.creatures.length>0&&($scope.creatures=$rootScope.model.creatures,$scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter)),$scope.onlyWithKnownTime=$cookieStore.get("onlyWithKnownTime")?$cookieStore.get("onlyWithKnownTime"):!1,$timeout(function(){$scope.$broadcast("rzSliderForceRender")}),$scope.creatureType=$cookieStore.get("creatureType")?$cookieStore.get("creatureType"):{titan:!0,hero:!0},$scope.sendRequest=function(){call({method:"POST",url:"/registerEvent",data:{token:"bcf3e0ce2f2986c9d7a5e651446de927654161635ab77a4e5c137cc0765f6751746ea326620c88f37674ebe1914ff37a",nick:"Nir",creature:"Renegat Baulus",group:["Nir","Szopen","iiiiii","pppp","pooo"],place:"Mroczny przesmyk",guest:!0}},function(data){console.log(data)})},$scope.lvlRangeSlider={minValue:$cookieStore.get("lvlRange.minValue")?$cookieStore.get("lvlRange.minValue"):20,maxValue:$cookieStore.get("lvlRange.maxValue")?$cookieStore.get("lvlRange.maxValue"):320,options:{floor:20,ceil:320,step:1,onChange:function(){$scope.filter.lvlRange=$scope.lvlRangeSlider,$scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter),$cookieStore.put("lvlRange.minValue",$scope.lvlRangeSlider.minValue),$cookieStore.put("lvlRange.maxValue",$scope.lvlRangeSlider.maxValue)}}},$scope.timeSlider={value:24,options:{onChange:function(){$scope.filter.hoursToResp=$scope.timeSlider.value,$scope.filteredCreatures=creaturesFilter.filter(angular.copy($scope.creatures),$scope.filter),$cookieStore.put("hoursToResp",$scope.timeSlider.value)}}},$scope.$watch("creatureType",function(creatureType){$cookieStore.put("creatureType",creatureType),$scope.filter.creatureType=creatureType,$scope.filteredCreatures=creaturesFilter.filter(angular.copy($scope.creatures),$scope.filter)},!0),$scope.$watch("queryInput",function(queryInput){$scope.filter.queryInput=queryInput,(null!=$scope.filter.queryInput||void 0!=$scope.filter.queryInput)&&($scope.filteredCreatures=creaturesFilter.filter(angular.copy($scope.creatures),$scope.filter))}),$scope.$watch("onlyWithKnownTime",function(onlyWithKnownTime){$scope.filter.onlyWithKnownTime=onlyWithKnownTime,$scope.filteredCreatures=creaturesFilter.filter(angular.copy($scope.creatures),$scope.filter),$cookieStore.put("onlyWithKnownTime",onlyWithKnownTime)})}]),angular.module("login",["ngEnter","userAuthService","controls.hcValidationPattern"]).controller("loginCtrl",["$scope","$rootScope","dataSource","$http","userAuthService","appStates","$state","notificationService","$stateParams",function($scope,$rootScope,dataSource,$http,userAuthService,appStates,$state,notificationService,$stateParams){$rootScope.showLogout=!1,$scope.logg=function(login,password){userAuthService.loggIn(login,password).then(function(){$rootScope.states=appStates[!0],userAuthService.setLogged(!0),$state.go(""!==$stateParams.destinationState?$stateParams.destinationState:$rootScope.states[0].reference,$stateParams.destinationParams)})}}]),angular.module("creatureProfile",[]).controller("creatureProfileCtrl",["$scope","$rootScope","dataSource","$location","$stateParams","$state","locales",function($scope,$rootScope,dataSource,$location,$stateParams,$state,locales){$scope.pieChartData=[];var preparePieChartData=function(){var dateMap=$scope.creatureProfileModel.dateMap,chartData=[{value:dateMap.morning,label:locales.timeOfTheDay.morning},{value:dateMap.afternoon,label:locales.timeOfTheDay.afternoon},{value:dateMap.evening,label:locales.timeOfTheDay.evening},{value:dateMap.night,label:locales.timeOfTheDay.night}];return console.log(chartData,"piechartdata"),chartData},evaluatePieChartData=function(){var hasData=!1,dateMap=$scope.creatureProfileModel.dateMap;return(dateMap.morning>0||dateMap.afternoon>0||dateMap.evening>0||dateMap.night>0)&&(hasData=!0),hasData},getCreatureById=function(id){for(var creatures=$scope.model.creatures,i=0,len=creatures.length;len>i;i++)if(creatures[i].id==id)return creatures[i]};$stateParams.creatureId&&dataSource.getCreatureProfile(parseInt($stateParams.creatureId)).then(function(data){$scope.creatureProfileModel=data,$scope.creatureProfileModel.creature=getCreatureById($stateParams.creatureId),$scope.summaryBattles=data.battlesCount+data.reportsCount,evaluatePieChartData()&&($scope.pieChartData=preparePieChartData())})}]),angular.module("profile",[]).controller("profileCtrl",["$scope","$rootScope","dataSource","$location","$stateParams","defaultAvatar","$state","locales",function($scope,$rootScope,dataSource,$location,$stateParams,defaultAvatar,$state,locales){function compareBattleCount(a,b){return a.creatureBattleCount>b.creatureBattleCount?-1:a.creatureBattleCount<b.creatureBattleCount?1:0}console.log("profileCtrl"),$scope.defaultAvatarLink=defaultAvatar.link,$scope.userProfileModel={},$scope.stripeChartData=[],$scope.pieChartData=[],$scope.goToUserProfile=function(id){id&&$state.go("profile",{userId:id})};var evaluatePieChartData=function(){var hasData=!1,guestDateMap=$scope.userProfileModel.guestHeroStats.dateMap,mainDateMap=$scope.userProfileModel.mainHeroStats.dateMap,summaryMorning=guestDateMap.morning+mainDateMap.morning,summaryafternoon=guestDateMap.afternoon+mainDateMap.afternoon,summaryEvening=guestDateMap.evening+mainDateMap.evening,summaryNight=guestDateMap.night+mainDateMap.night;return(summaryMorning>0||summaryafternoon>0||summaryEvening>0||summaryNight>0)&&(hasData=!0),hasData},preparePieChartData=function(){var guestDateMap=$scope.userProfileModel.guestHeroStats.dateMap,mainDateMap=$scope.userProfileModel.mainHeroStats.dateMap,chartData=[{value:guestDateMap.morning+mainDateMap.morning,label:locales.timeOfTheDay.morning},{value:guestDateMap.afternoon+mainDateMap.afternoon,label:locales.timeOfTheDay.afternoon},{value:guestDateMap.evening+mainDateMap.evening,label:locales.timeOfTheDay.evening},{value:guestDateMap.night+mainDateMap.night,label:locales.timeOfTheDay.night}];return console.log(chartData,"piechartdata"),chartData},concatCreatures=function(arrayWithDuplicates){for(var concatedCreatures=[],creaturesMap={},i=0,len=arrayWithDuplicates.length;len>i;i++){var currentElement=arrayWithDuplicates[i];creaturesMap[currentElement.creatureId]?creaturesMap[currentElement.creatureId].creatureBattleCount+=currentElement.creatureBattleCount:creaturesMap[currentElement.creatureId]={creatureBattleCount:currentElement.creatureBattleCount}}for(var item in creaturesMap)concatedCreatures.push({creatureId:parseInt(item),creatureBattleCount:creaturesMap[item].creatureBattleCount});return concatedCreatures},prepareStripeChartData=function(){var chartData=[],sortedData=[],topCount=0;chartData=concatCreatures($scope.userProfileModel.mainHeroStats.creatures.concat($scope.userProfileModel.guestHeroStats.creatures));for(var i=0,len=chartData.length;len>i;i++)$rootScope.model.creatures.map(function(currentCreature){currentCreature.id===chartData[i].creatureId&&(chartData[i].name=currentCreature.name)});if(topCount=chartData.length>=3?3:chartData.length,console.log(topCount,"asas"),sortedData=chartData.sort(compareBattleCount),sortedData.length>topCount){var howManyElements=sortedData.length-topCount;sortedData.splice(topCount-1,howManyElements)}return sortedData};$stateParams.userId&&dataSource.getUserProfile($stateParams.userId).then(function(data){$scope.userProfileModel=data,$scope.stripeChartData=prepareStripeChartData(),evaluatePieChartData()&&($scope.pieChartData=preparePieChartData())})}]),angular.module("register",["ngEnter"]).controller("registerCtrl",["$scope","$rootScope","dataSource","$http","userAuthService","$state","locales","notificationService",function($scope,$rootScope,dataSource,$http,userAuthService,$state,locales,notificationService){$scope.register=function(registerData){userAuthService.register(registerData).then(function(){notificationService.showSuccessNotification(locales.waitingForConfirmation,!0),$state.go("login")})}}]),angular.module("settings",["ngFileUpload","ngImgCrop"]).controller("settingsCtrl",["$scope","$rootScope","dataSource","avatarService","notificationService","defaultAvatar",function($scope,$rootScope,dataSource,avatarService,notificationService,defaultAvatar){var setDefaultSettingsValues=function(){$scope.editPasswordSettings=null,$scope.editContactSettings=null,$scope.editEmailSettings=null,$scope.editAvatar=null,$scope.croppedImg=null,$scope.loadedImg=null,$scope.passwordModel={},$scope.emailModel={}},counter=0;$scope.defaultAvatarLink=defaultAvatar.link,$rootScope.$on("dataSource.ready",function(){counter++,$scope.model=$rootScope.model,1===counter&&$rootScope.model.personalData.isAdministrator,console.log("settings datasource ready",counter),setDefaultSettingsValues()});var createSettingsCheckpoint=function(data){var savedSettings={gg:data.gg,ggVisible:data.ggVisible,phone:data.phone,phoneVisible:data.phoneVisible,name:data.name};return savedSettings},settingsCheckpoint={};$scope.uploadAvatar=function(){$scope.croppedImg&&($scope.showAvatarOverlay=!0,dataSource.changeAvatar($rootScope.model.personalData.id,$scope.croppedImg).then(function(){$scope.showAvatarOverlay=!1},function(){$scope.showAvatarOverlay=!1}))},$scope.cancelUploadAvatar=function(){$scope.croppedImg=null,$scope.editAvatar=!1,$scope.loadedImg=null},$scope.changeContactSettings=function(){$scope.editContactSettings=!0,settingsCheckpoint=createSettingsCheckpoint($scope.model.personalData)};var restoreSettingsCheckpoint=function(){var personalData=$scope.model.personalData;personalData.gg=settingsCheckpoint.gg,personalData.ggVisible=settingsCheckpoint.ggVisible,personalData.phonw=settingsCheckpoint.phone,personalData.phoneVisible=settingsCheckpoint.phoneVisible,personalData.name=settingsCheckpoint.name};$scope.applyContactSettings=function(){$scope.showContactOverlay=!0;var contactSettingsPromise=dataSource.applyContactSettings($scope.model.personalData);contactSettingsPromise.then(function(data){$scope.editContactSettings=!1,$scope.showContactOverlay=!1,settingsCheckpoint=createSettingsCheckpoint(data),notificationService.showSuccessNotification("Contact settings succesfully changed")},function(){$scope.showContactOverlay=!1,restoreSettingsCheckpoint()})},$scope.cancelContactSettings=function(){$scope.editContactSettings=!1,restoreSettingsCheckpoint()},$scope.cancelChangeEmail=function(){$scope.editEmailSettings=!1},$scope.changeEmail=function(changeEmailForm){$scope.showEmailOverlay=!0;var changeEmailPromise=dataSource.changeEmail($rootScope.model.personalData,changeEmailForm.oldEmail,changeEmailForm.newEmail);changeEmailPromise.then(function(data){$scope.editEmailSettings=!1,$scope.showEmailOverlay=!1,notificationService.showSuccessNotification("Successfully change your email address to "+data.email)})},$scope.readFileImg=function(files){$scope.loadedImg=null,$scope.success=null,files&&files.length&&avatarService.readImageFile(files[0]).then(function(img){$scope.loadedImg=img})},$scope.changePassword=function(changePasswordForm){$scope.showPasswordOverlay=!0;var changePasswordPromise=dataSource.changePassword($rootScope.model.personalData,changePasswordForm.oldPassword,changePasswordForm.newPassword);changePasswordPromise.then(function(){$scope.showPasswordOverlay=!0,$scope.editPasswordSettings=!1,notificationService.showSuccessNotification("Successfully change your password")})},$scope.cancelChangePassword=function(){$scope.editPasswordSettings=!1};var tempContactFieldVal="";$scope.rememberContactValue=function(field){tempContactFieldVal=$scope.model.personalData[field]},$scope.restoreContactValue=function(field){$scope.model.personalData[field]||($scope.model.personalData[field]=tempContactFieldVal)}}]),angular.module("userManager",["ngEnter"]).controller("userManagerCtrl",["$scope","$rootScope","dataSource","notificationService","defaultAvatar",function($scope,$rootScope,dataSource,notificationService,defaultAvatar){$scope.defaultAvatarLink=defaultAvatar.link,$scope.filterConfig={field:"name",reverse:!1},$rootScope.$on("dataSource.ready",function(){$scope.users=$rootScope.model.users}),$rootScope.model.personalData&&$rootScope.model.personalData.isAdministrator&&dataSource.getUsers(),$scope.setFilter=function(field){$scope.filterConfig.field=field,field===$scope.filterConfig.field&&($scope.filterConfig.reverse=!$scope.filterConfig.reverse)},$scope.openDetails=function(user){null!==user.waitForAccept&&($scope.activeUserId=user.id)},$scope.acceptUser=function(user){var acceptUserPromise=dataSource.acceptUserActivation(user);$scope.showUserDetailsOverlay=!0,acceptUserPromise.then(function(){$scope.showUserDetailsOverlay=!1,notificationService.showSuccessNotification("user "+user.name+" successfully accepted")})},$scope.rejectUser=function(user){$scope.showUserDetailsOverlay=!0;var rejectUserPromise=dataSource.rejectUserActivation(user);rejectUserPromise.then(function(){$scope.showUserDetailsOverlay=!1,notificationService.showSuccessNotification("user "+user.name+" successfully rejected")})},$scope.setAdministrator=function(user){$scope.showUserDetailsOverlay=!0;var setAdministratorPromise=dataSource.setAdministrator(user);setAdministratorPromise.then(function(){$scope.showUserDetailsOverlay=!1,notificationService.showSuccessNotification("user "+user.name+" was successfully grant to administrator")})},$scope.setCommonUser=function(user){$scope.showUserDetailsOverlay=!0;var setCommonUserPromise=dataSource.setCommonUser(user);setCommonUserPromise.then(function(){$scope.showUserDetailsOverlay=!1,notificationService.showSuccessNotification("user "+user.name+" was successfully grant to standard user")})}}]);