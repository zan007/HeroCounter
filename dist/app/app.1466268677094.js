angular.module("activation",["dataSource","ui.router"]).controller("activationCtrl",["$scope","$rootScope","$location","dataSource",function($scope,$rootScope,$location,dataSource){console.log("activationToken",$location.search().token),$rootScope.$on("app-ready",function(){console.log("activationCtrl"),dataSource.activateUserAccount($location.search().token)})}]),$script.ready("angular",function(){angular.module("heroCounter",["ui.router","ngAnimate","ngMessages","register","login","heroes","profile","activation","settings","userManager","dataSource","ngTouch","ngEnter","constants","timer","userAuthService","socketFactory","notificationService","utils.fastFilter","ngCookies","controls.hcPrettyTime","controls.hcEventsTimeline","controls.hcValidationPattern","controls.hcEqual","controls.hcNotEqual","controls.hcUserHeroTile","avatarService","ngImgCrop"]).config(["$httpProvider","$stateProvider","$urlRouterProvider",function($httpProvider,$stateProvider,$urlRouterProvider){$httpProvider.interceptors.push(function($q,$location,$window){return{response:function(response){return console.log("sukces"),response},responseError:function(response){return console.log("error"),401===response.status&&(console.log("401"),$window.location.reload()),$q.reject(response)}}}),$urlRouterProvider.otherwise(function(){return"/heroes"}),$stateProvider.state("heroes",{url:"/heroes",templateUrl:"/heroes",authRequire:!0,params:{newsVisible:!0}}).state("login",{url:"/login",templateUrl:"/",authRequire:!1,params:{newsVisible:!1,destinationState:"",destinationParams:""}}).state("register",{url:"/register",templateUrl:"/register",authRequire:!1,params:{newsVisible:!1}}).state("settings",{url:"/settings",templateUrl:"/settings",authRequire:!0,params:{newsVisible:!1}}).state("userManager",{url:"/user-manager",templateUrl:"/user-manager",authRequire:!0,params:{newsVisible:!1}}).state("activation",{url:"/activation",templateUrl:"/activation",authRequire:!1,params:{newsVisible:!1}}).state("profile",{url:"/profile?userId",templateUrl:"/profile",authRequire:!0,params:{newsVisible:!0}}).state("basic",{url:"/basic",templateUrl:"/basic",authRequire:!1,params:{newsVisible:!1}})}]).run(function($rootScope,userAuthService,$state,adminRestrictedStates){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState){if(void 0!==userAuthService.getIsLogged())if(!userAuthService.getIsLogged()||"register"!==toState.name&&"login"!==toState.name){var isAuthenticationRequired=toState.authRequire&&!userAuthService.getIsLogged();isAuthenticationRequired&&(event.preventDefault(),$state.go("login",{destinationState:toState.name,destinationParams:toParams}))}else event.preventDefault(),$state.go(fromState);var isPersonalDataReady=$rootScope.model&&$rootScope.model.personalData;adminRestrictedStates[toState.name]&&isPersonalDataReady&&!$rootScope.model.personalData.isAdministrator&&$state.go(fromState.name||"login")})}).constant("appStates",{"true":[{reference:"heroes",selected:!0,name:"HEROES"},{reference:"settings",selected:!1,name:"SETTINGS"}],"false":[{reference:"login",selected:!0,name:"LOGIN"},{reference:"register",selected:!1,name:"REGISTER"}]}).constant("adminRestrictedStates",{userManager:!0}).controller("AppCtrl",["$rootScope","$scope","dataSource","userAuthService","$state","appStates","notificationService","$stateParams","socketFactory","defaultAvatar",function($rootScope,$scope,dataSource,userAuthService,$state,appStates,notificationService,$stateParams,socketFactory,defaultAvatar){userAuthService.init(),$rootScope.showLogout=!1,$scope.stateParams=$stateParams,$scope.defaultAvatarLink=defaultAvatar.link,$rootScope.$on("app-ready",function(){$rootScope.states=appStates[userAuthService.getIsLogged()],userAuthService.getIsLogged()&&($rootScope.showLogout=!0,dataSource.init(),socketFactory.initializeSocket(),createSocketEventHandlers()),$state.reload(!0)}),$rootScope.$on("auth-login-success",function(){dataSource.init(),socketFactory.initializeSocket(),createSocketEventHandlers(),$rootScope.showLogout=!0}),$rootScope.$on("dataSource.ready",function(){$scope.personalData=$rootScope.model.personalData,$scope.events=$rootScope.model.events}),$scope.btnClick=!1,$scope.logout=function(){userAuthService.logout().then(function(){$rootScope.states=appStates[userAuthService.getIsLogged()],$rootScope.model={},socketFactory.disconnect(),$state.go($rootScope.states[0].reference)})};var createSocketEventHandlers=function(){socketFactory.getSocket().then(function(socket){socket.on("hello",function(){console.log("udalo sie hello")}),socket.on("creaturesUpdated",function(data){console.log("zupdatowana lista ",data),$rootScope.model.creatures=data.creatures,notificationService.showInfoNotification("Creatures list updated"),$rootScope.$broadcast("dataSource.ready")}),socket.on("eventsUpdated",function(data){console.log("nowy event",data),$rootScope.model.events.unshift(data),notificationService.showInfoNotification("Events list updated"),$rootScope.$broadcast("dataSource.ready")})})}}])}),angular.module("constants",[]).constant("defaultAvatar",{link:"http://res.cloudinary.com/hero-counter/image/upload/v1465058452/default-avatar_lcdclq.png"}),angular.module("appAnimations",[]).animation(".list-out",["$window",function($window){return{start:function(element,done){TweenMax.set(element,{position:"relative"});var duration=1;TweenMax.to(element,1,{opacity:0,width:0}),$window.setTimeout(done,1e3*duration)}}}]).animation(".list-in",["$window",function($window){return{setup:function(element){TweenMax.set(element,{opacity:0,width:0})},start:function(element,done){var duration=1;TweenMax.to(element,duration,{opacity:1,width:210}),$window.setTimeout(done,1e3*duration)}}}]).animation(".list-move",["$window",function($window){return{start:function(element,done){var duration=1;TweenMax.to(element,duration,{opacity:1,width:210}),$window.setTimeout(done,1e3*duration)}}}]),angular.module("controls.hcCreatureTile",["dataSource"]).directive("hcCreatureTile",["dataSource",function(dataSource){return{scope:{creature:"=hcCreatureTile"},replace:!0,restriction:"E",link:function($scope){$scope.startCountdown=function(creature){dataSource.defeatCreature(creature)}},templateUrl:"hc-creature-tile"}}]),angular.module("controls.hcEqual",[]).directive("hcEqual",function(){return{require:"ngModel",scope:{equalTo:"=hcEqual"},link:function($scope,iElm,iAttrs,ctrl){iAttrs.$observe("hcEqual",function(value){ctrl.$setValidity("hcEqual",!0),value&&ctrl.$validate()}),$scope.$watch("equalTo",function(newVal,oldVal){newVal!==oldVal&&ctrl.$validate()}),ctrl.$validators.hcEqual=function(value){var equalResult=!0,result=!0;return value&&(result=value===$scope.equalTo),ctrl.$setValidity("hcEqual",result),equalResult=equalResult&&result}}}}),angular.module("controls.hcEventsTimeline",["dataSource"]).directive("hcEventsTimeline",["$rootScope","dataSource",function(){return{scope:{events:"=hcEventsTimeline",middle:"=middle"},replace:!0,restriction:"E",link:function($scope){$scope.getDayName=function(date){var currentDate=new Date,eventDate=new Date(date),currentYearMonth=currentDate.getMonth()+1+" "+currentDate.getYear(),eventYearMonth=eventDate.getMonth()+1+" "+eventDate.getYear();return currentYearMonth===eventYearMonth&&currentDate.getDate()===eventDate.getDate()?"today":currentYearMonth===eventYearMonth&&currentDate.getDate()-1===eventDate.getDate()?"yesterday":eventDate.getDate()+"."+(eventDate.getMonth()+1)},$scope.showDayLabel=function(event,index){if(0===index)return!0;var currentEventDay=new Date(event.battleDate).getDay(),prevEventDay=new Date($scope.events[index-1].battleDate).getDay();return currentEventDay!=prevEventDay}},templateUrl:"hc-events-timeline"}}]),angular.module("controls.hcNotEqual",[]).directive("hcNotEqual",function(){return{require:"ngModel",scope:{notEqualTo:"=hcNotEqual"},link:function($scope,iElm,iAttrs,ctrl){iAttrs.$observe("hcNotEqual",function(value){ctrl.$setValidity("hcNotEqual",!0),value&&ctrl.$validate()}),$scope.$watch("notEqualTo",function(newVal,oldVal){newVal!==oldVal&&ctrl.$validate()}),ctrl.$validators.hcNotEqual=function(value){var equalResult=!0,result=!0;return value&&(result=value!==$scope.notEqualTo),ctrl.$setValidity("hcNotEqual",result),equalResult=equalResult&&result}}}}),angular.module("controls.hcPrettyTime",[]).directive("hcPrettyTime",function(){return{scope:{date:"=hcPrettyTime",fullDate:"@"},replace:!0,restriction:"E",link:function($scope){var convertDate=function(){var date=new Date($scope.date);$scope.hours=date.getHours(),$scope.minutes=date.getMinutes(),$scope.fullDate&&($scope.day=date.getDay(),$scope.month=date.getMonth(),$scope.year=date.getFullYear())};$scope.$watch("date",function(newDate,oldDate){console.log("newDate",newDate,"olddate",oldDate),convertDate()},!0)},templateUrl:"hc-pretty-time"}}),angular.module("controls.hcUserHeroTile",["dataSource"]).directive("hcUserHeroTile",["$rootScope","dataSource",function(){return{scope:{hero:"=hcUserHeroTile",stats:"="},replace:!0,restriction:"E",templateUrl:"hc-user-hero-tile",link:function($scope,$elem){function radialProgress(parent,max){function drawBackground(group){var background=group.append("g").attr("class","component");s.arc.outer.endAngle(360*(Math.PI/180)),background.append("path").attr("transform","translate("+s.width/2+","+s.width/2+")").attr("d",s.arc.outer)}function drawArcs(svg,mainGroup){mainGroup.append("g").attr("class","arcs");svg.select(".arcs").selectAll(".arc").data(s.data,function(d){return d.type}).enter().append("path").attr("class",function(d){return"arc "+d.type+"-arc"}).attr("transform","translate("+s.width/2+","+s.height/2+")").attr("d",function(d){return s.arc[d.type]()}).each(function(d){var range=s.bound.max-s.bound.min,ratio=(d.value-s.bound.min)/range,endAngle=Math.min(360*ratio,360)*Math.PI/180;s.goal[d.type]=endAngle,d3.select(this).transition().duration(s.duration).attrTween("d",arcTween)})}function component(){d3.select(parent).each(function(){var svg=d3.select(this).append("svg"),mainGroup=svg.attr("class","radial-svg").append("g").attr("class","main-group").attr("transform","translate("+s.margin.left+","+s.margin.top+")");drawBackground(mainGroup),drawArcs(svg,mainGroup)})}function arcTween(d){var i=d3.interpolate(0,s.goal[d.type]);return function(t){return s.arc[d.type].endAngle(i(t))()}}function measure(){s.width=s.diameter-s.margin.right-s.margin.left-s.margin.top-s.margin.bottom,s.height=s.width;var halfw=s.width/2,_80w=.95*halfw,_20w=.05*halfw;s.arc.outer.outerRadius(halfw),s.arc.outer.innerRadius(_80w),s.arc.inner.outerRadius(_80w),s.arc.inner.innerRadius(_80w-_20w)}var d3=window.d3,s={duration:1e3,margin:{top:0,right:0,bottom:0,left:0},width:150,height:150,diameter:0,bound:{min:0,max:max>0?max:100},goal:{outer:3.14,inner:6.28},data:[{type:"outer",value:0},{type:"inner",value:0}],arc:{outer:d3.svg.arc().startAngle(0*(Math.PI/180)),inner:d3.svg.arc().startAngle(0*(Math.PI/180)).endAngle(0)}};return component.render=function(){return measure(),component(),component},component.data=function(_){return arguments.length?(s.data=_,component):s.data},component.margin=function(_){return arguments.length?(s.margin=_,component):s.margin},component.diameter=function(_){return arguments.length?(s.diameter=_,component):s.diameter},component.minValue=function(_){return arguments.length?(s.bound.min=_,component):s.bound.min},component.maxValue=function(_){return arguments.length?(s.bound.max=_,component):s.bound.max},component.duration=function(_){return arguments.length?(s.duration=_,component):s.duration},component}$scope.battleCount=0,$scope.radialChartElem=$elem.find("g"),$scope.$watch("stats",function(stats){for(var battles=stats.battles,i=0,len=battles.length;len>i;i++){var currentBattle=battles[i];currentBattle.heroId===$scope.hero.id&&($scope.battleCount=currentBattle.battleCount)}radialProgress($scope.radialChartElem[0],$scope.stats.summaryBattles).diameter(150).data([{type:"outer",value:$scope.battleCount}]).render()})}}}]),angular.module("controls.hcValidationPattern",[]).constant("validationPatterns",{TEXT:/^[^\x22\x27\x26\x3C\x3E\x24\x60\u2013\u2014\u2018\u2019\u201C\u201D\u2022\u2026\u201A\u201E-]*$/,EMAIL:/^([^.@]+)(\.[^.@]+)*@([^.@]+\.)+[^.@]{2,6}$/,EMAIL_CHARS:/^[a-zA-Z0-9_\-\.\@]+$/}).directive("hcValidationPattern",["validationPatterns",function(validationPatterns){var patternCache={},getRegExp=function(patternKey){var regExp=patternCache[patternKey];if(!regExp){var pattern=validationPatterns[patternKey];if(!pattern)return null;regExp=patternCache[patternKey]=new RegExp(pattern)}return regExp};return{require:"ngModel",link:function($scope,iElm,iAttrs,ctrl){var patternRegExps;iAttrs.$observe("hcValidationPattern",function(value){for(var i=0;patternRegExps&&i<patternRegExps.length;i++)ctrl.$setValidity("hcValidationPattern."+patternRegExps[i].patternKey,!0);value?(patternRegExps=value.split(",").map(function(patternKey){return{patternKey:patternKey,validator:getRegExp(patternKey)}}),ctrl.$validate()):patternRegExps=null}),ctrl.$validators.hcValidationPattern=function(value){if(!patternRegExps)return!0;for(var patternResult=!0,i=0;i<patternRegExps.length;i++){var result=patternRegExps[i].validator.test(value);ctrl.$setValidity("hcValidationPattern."+patternRegExps[i].patternKey,result),patternResult=patternResult&&result}return patternResult}}}}]),angular.module("ngEnter",[]).directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),angular.module("dataSource",[]).factory("dataSource",["$http","$q","$rootScope","$location","notificationService",function($http,$q,$rootScope,$location,notificationService){var initModel=function(){$rootScope.model={creatures:[],personalData:{},events:[],users:[]}};initModel(),$rootScope.opened=!1;var call=function(httpData,responseFn){$rootScope.$broadcast("dataSource.start");var promise=$http(httpData).then(function(response){var result;return responseFn&&(result=responseFn(response.data,response.status,response.headers)),$rootScope.$broadcast("dataSource.stop"),result||response.data}).then(null,function(reason){return console.log(reason),notificationService.showErrorNotification(reason.data.message,reason.data.persistence),$rootScope.$broadcast("dataSource.error"),$q.reject(reason)});return promise};return{call:call,defeatCreature:function(creature){return call({method:"POST",url:"/defeat",data:{creatureName:creature.name}},function(){})},init:function(){return call({method:"GET",url:"/init",data:{}},function(data){$rootScope.model.creatures=data.creatures,$rootScope.model.personalData=data.personalData,$rootScope.model.events=data.events,$rootScope.model.users=data.users,$rootScope.$broadcast("dataSource.ready")})},register:function(registerData){return call({method:"POST",url:"/signup",data:{login:registerData.login,password:registerData.password,email:registerData.email,name:registerData.name}},function(){})},logg:function(credential){return call({method:"POST",url:"/login",data:{login:credential.login,password:credential.password}},function(){})},isLoggedIn:function(){var deferred=$q.defer();return $http.get("/isLoggedIn").success(function(user){user?deferred.resolve(user):deferred.reject()}),deferred.promise},logout:function(){return call({method:"GET",url:"/logout",data:{}},function(){initModel(),$rootScope.$broadcast("dataSource.ready")})},getUsers:function(){return call({method:"POST",url:"/getUsers",data:{userToken:$rootScope.model.personalData.userToken}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},activateUserAccount:function(token){return call({method:"POST",url:"/activate",data:{token:token}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},acceptUserActivation:function(user){return call({method:"POST",url:"/acceptUserActivation",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},setAdministrator:function(user){return call({method:"POST",url:"/setAdministrator",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},setCommonUser:function(user){return call({method:"POST",url:"/setCommonUser",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},rejectUserActivation:function(user){return call({method:"POST",url:"/rejectUserActivation",data:{userToken:$rootScope.model.personalData.userToken,userId:user.id}},function(data){$rootScope.model.users=data,$rootScope.$broadcast("dataSource.ready")})},changeEmail:function(user,oldEmailAddress,newEmailAddress){return call({method:"POST",url:"/changeEmail",data:{userId:user.id,oldEmail:oldEmailAddress,newEmail:newEmailAddress}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})},changePassword:function(user,oldPassword,newPassword){return call({method:"POST",url:"/changePassword",data:{userId:user.id,oldPassword:oldPassword,newPassword:newPassword}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})},changeAvatar:function(userId,avatar){return call({method:"POST",url:"/changeAvatar",data:{userId:userId,avatar:avatar}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})},applyContactSettings:function(contactSettingsModel){return call({method:"POST",url:"/applySettings",data:{phoneNumber:contactSettingsModel.phone,phoneVisible:contactSettingsModel.phoneVisible,ggNumber:contactSettingsModel.gg,ggVisible:contactSettingsModel.ggVisible,name:contactSettingsModel.name,userId:contactSettingsModel.id}},function(data){$rootScope.model.personalData=data,$rootScope.$broadcast("dataSource.ready")})},getUserProfile:function(userId){return call({method:"GET",url:"/getUserProfile",params:{userId:userId}},function(){})}}}]),angular.module("creatureLvlFilter",[]).filter("creatureLvlFilter",function(){return function(input,lvlRange){if(!input)return input;for(var output=[],from=lvlRange.minValue,to=lvlRange.maxValue,i=0;i<input.length;i++)currentItem=input[i],currentItem.lvl>=from&&currentItem.lvl<=to&&output.push(input[i]);return output}}),angular.module("creatureTypeFilter",[]).filter("creatureTypeFilter",function(){return function(input,type){if(!input)return input;for(var output=[],i=0;i<input.length;i++)currentItem=input[i],"titan"!==currentItem.type&&"event-titan"!==currentItem.type||!type.titan||output.push(input[i]),"hero"!==currentItem.type&&"event-hero"!==currentItem.type||!type.hero||output.push(input[i]);return output}}),angular.module("filters.creaturesFilter",["creatureTypeFilter","creatureLvlFilter","respTimeFilter","utils.fastFilter","creaturesQueryFilter","onlyWithKnownTimeFilter"]).factory("creaturesFilter",["$rootScope","fastFilter",function($rootScope,fastFilter){return fastFilter.create("onlyWithKnownTimeFilter:onlyWithKnownTime | creatureTypeFilter:creatureType | creatureLvlFilter:lvlRange | creaturesQueryFilter:queryInput | respTimeFilter:hoursToResp",{creatureType:{titan:!0,hero:!0},lvlRange:{minValue:20,maxValue:320},hoursToResp:2,onlyWithKnownTime:!0})}]),angular.module("creaturesQueryFilter",[]).constant("localLetters",{"ą":"a","ć":"c","ę":"e","ł":"l","ń":"n","ó":"o","ś":"s","ź":"z"}).filter("creaturesQueryFilter",function(localLetters){var localLettersChain="ą|ć|ę|ł|ń|ó|ś|ź";return function(input,query){if(!input||!query)return input;for(var output=[],queryWithoutLocal=query.replace(new RegExp(localLettersChain,"gi"),function(matched){return localLetters[matched]}),i=0;i<input.length;i++)currentItem=input[i],(-1!=currentItem.name.toLowerCase().indexOf(query)||-1!=currentItem.name.toLowerCase().indexOf(queryWithoutLocal)||-1!=currentItem.name.indexOf(query)||-1!=currentItem.name.indexOf(queryWithoutLocal))&&output.push(input[i]);return output}}),angular.module("onlyWithKnownTimeFilter",[]).filter("onlyWithKnownTimeFilter",function(){return function(input,onlyWithKnownTime){if(!input)return input;for(var output=[],i=0;i<input.length;i++)currentItem=input[i],onlyWithKnownTime?currentItem.timeToResp&&output.push(input[i]):output.push(input[i]);return output}}),angular.module("respTimeFilter",[]).filter("respTimeFilter",function(){return function(input){if(!input)return input;return input}}),angular.module("avatarService",[]).factory("avatarService",["$q","notificationService",function($q,notificationService){return{uploadAvatar:function(){},readImageFile:function(file){var deferred=$q.defer();if(window.FileReader){file.size>4e6&&(notificationService.showErrorNotification("Error, photo exceeds max size limit."),deferred.reject()),file.type.match("image.*")||(notificationService.showErrorNotification("Error, file must be a photo."),deferred.reject());var reader=new FileReader;reader.onloadend=function(event){null!=event.target.error?(notificationService.showErrorNotification("Error, please try another photo."),deferred.reject()):deferred.resolve(reader.result)},reader.readAsDataURL(file)}else notificationService.showErrorNotification("Sorry, this browser doesn't support photo uploads."),deferred.reject();return deferred.promise}}}]),angular.module("notificationService",["ui-notification"]).config(function(NotificationProvider){NotificationProvider.setOptions({delay:2e3,startTop:20,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"left",positionY:"bottom"})}).factory("notificationService",function(Notification){return{showInfoNotification:function(message){Notification.info(message)},showErrorNotification:function(message,persistence){var messageTitle='<i class="icon-error"></i><div class="subtitle">Ooops, something went wrong.</div>';Notification.error({message:message,title:messageTitle,delay:persistence?15e3:2e3})},showSuccessNotification:function(message){Notification.success({title:'<i class="icon-success"></i><div class="subtitle">'+message+"</div>"})}}}),angular.module("socketFactory",[]).factory("socketFactory",["$q","$rootScope","$timeout","userAuthService","$location",function($q,$rootScope,$timeout,userAuthService,$location){function getSocket(){return socket&&deferred.resolve(socket),deferred.promise}var socket="",deferred=$q.defer();return{initializeSocket:function(){socket=new io,socket=io.connect($location.protocol()+"://"+$location.host()+":"+$location.port()),deferred.resolve(socket)},disconnect:function(){socket.removeAllListeners()},getSocket:getSocket}}]),angular.module("userAuthService",[]).constant("AUTH_EVENTS",{sessionTimeout:"auth-session-timeout",loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",notAuthenticated:"auth-not-authenticated",authenticated:"auth-authenticated"}).factory("userAuthService",["$rootScope","dataSource","$http","$q","AUTH_EVENTS",function($rootScope,dataSource,$http,$q,AUTH_EVENTS){var self=this;this.isLogged;var setLogged=function(value){self.isLogged=value},getIsLogged=function(){return self.isLogged},getUserAuthData=function(){var deferred=$q.defer();return dataSource.isLoggedIn().then(function(data){data&&data.hasOwnProperty("password")?(setLogged(!0),console.log("serwis, ",data),$rootScope.$broadcast(AUTH_EVENTS.authenticated),deferred.resolve(data)):(setLogged(!1),$rootScope.$broadcast(AUTH_EVENTS.notAuthenticated),deferred.resolve())}),deferred.promise},init=function(){getUserAuthData().then(function(){$rootScope.$broadcast("app-ready")})},loggIn=function(login,password){var credentials={login:login,password:password},deferred=$q.defer();return dataSource.logg(credentials).then(function(data){data?(setLogged(!0),$rootScope.$broadcast(AUTH_EVENTS.loginSuccess),deferred.resolve(data)):(deferred.reject(),$rootScope.$broadcast(AUTH_EVENTS.loginFailed))}),deferred.promise},logout=function(){var deferred=$q.defer();return dataSource.logout().then(function(data){console.log("logout service",data),setLogged(!1),$rootScope.$broadcast(AUTH_EVENTS.logoutSuccess),deferred.resolve()},function(){deferred.reject()}),deferred.promise},register=function(registerData){var deferred=$q.defer();return dataSource.register(registerData).then(function(){deferred.resolve()},function(){deferred.reject()}),deferred.promise};return{loggIn:loggIn,getIsLogged:getIsLogged,logout:logout,register:register,init:init,getUserAuthData:getUserAuthData,authEvents:AUTH_EVENTS,setLogged:setLogged}}]),angular.module("utils.fastFilter",[]).factory("fastFilter",["$filter","$rootScope",function($filter){return{create:function(filtersChain,initialFilterObj){function getFirstDirtyFilter(filterObj){var dirtyFilters=[];for(var param in filterObj)filterObj.hasOwnProperty(param)&&!angular.equals(filterObj[param],oldFilterObj[param])&&dirtyFilters.push(paramsMapping[param]);return dirtyFilters.length?filtersOrdered[Math.min.apply(Math,dirtyFilters)]:null}function runFiltersFromChain(chain,input,filterObj){if(0==chain.length)return input;var filter=filters[chain[0]];return filter.cached=input,runFiltersFromChain(chain.slice(1),filter.run(input,filterObj),filterObj)}for(var filterDescs=filtersChain.replace(/\s+/g,"").split("|"),filters=[],filtersOrdered=[],paramsMapping=[],i=0;i<filterDescs.length;i++){var filterMeta=filterDescs[i].split(":"),filterName=filterMeta[0],filterParams=filterMeta.slice(1);filtersOrdered[i]=filterName,filters[filterName]={name:filterName,params:filterParams,run:function(input,filterObj){for(var paramValues=[input],paramNames=this.params,i=0;i<paramNames.length;i++)paramValues[i+1]=filterObj[paramNames[i]];return $filter(this.name).apply(this,paramValues)},cached:void 0,order:i};for(var p=0;p<filterParams.length;p++)paramsMapping[filterParams[p]]=i}var oldInput=void 0,oldFilterObj=initialFilterObj,lastResult=void 0;return{filter:function(input,filterObj){if(!input)return input;var filterName=filtersOrdered[0];if(oldFilterObj&&input==oldInput&&(filterName=getFirstDirtyFilter(filterObj),!filterName))return lastResult;if(oldInput!=input)for(var key in filters)delete filters[key].cached;oldInput=input,oldFilterObj=angular.copy(filterObj);var filtersToExecute=filtersOrdered.slice(filters[filterName].order);if(filtersToExecute.length>0){var firstFilter=filters[filtersToExecute[0]];return lastResult=runFiltersFromChain(filtersToExecute,void 0===firstFilter.cached?input:firstFilter.cached,filterObj)}return input},get:function(){return angular.copy(oldFilterObj)}}}}}]),angular.module("heroes",["dataSource","ngEnter","controls.hcCreatureTile","rzModule","filters.creaturesFilter"]).controller("heroesCtrl",["$scope","$rootScope","dataSource","$http","creaturesFilter","$cookies","$cookieStore","$stateParams","$timeout","socketFactory","notificationService",function($scope,$rootScope,dataSource,$http,creaturesFilter,$cookies,$cookieStore,$stateParams,$timeout){$scope.filteredCreatures={},$scope.filter=creaturesFilter.get(),$rootScope.$on("dataSource.ready",function(){$scope.creatures=$rootScope.model.creatures,$scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter)}),$rootScope.model.creatures&&$rootScope.model.creatures.length>0&&($scope.creatures=$rootScope.model.creatures,$scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter)),$scope.onlyWithKnownTime=$cookieStore.get("onlyWithKnownTime")?$cookieStore.get("onlyWithKnownTime"):!1,$timeout(function(){$scope.$broadcast("rzSliderForceRender")}),$scope.creatureType=$cookieStore.get("creatureType")?$cookieStore.get("creatureType"):{titan:!0,hero:!0},$scope.sendRequest=function(){dataSource.call({method:"POST",url:"/registerEvent",data:{token:"bcf3e0ce2f2986c9d7a5e651446de927654161635ab77a4e5c137cc0765f6751746ea326620c88f37674ebe1914ff37a",nick:"Nirun",creature:"Renegat Baulus",group:["Nirun","Szopen"],place:"Mroczny przesmyk",guest:!0}},function(){})},$scope.lvlRangeSlider={minValue:$cookieStore.get("lvlRange.minValue")?$cookieStore.get("lvlRange.minValue"):20,maxValue:$cookieStore.get("lvlRange.maxValue")?$cookieStore.get("lvlRange.maxValue"):320,options:{floor:20,ceil:320,step:1,onChange:function(){$cookieStore.put("lvlRange.minValue",$scope.lvlRangeSlider.minValue),$cookieStore.put("lvlRange.maxValue",$scope.lvlRangeSlider.maxValue)}}},$scope.timeSlider={value:24},$scope.$watch("creatureType",function(creatureType){$cookieStore.put("creatureType",creatureType),$scope.filter.creatureType=creatureType,$scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter)},!0),$scope.$watch("queryInput",function(queryInput){$scope.filter.queryInput=queryInput,(null!=$scope.filter.queryInput||void 0!=$scope.filter.queryInput)&&($scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter))}),$scope.$watch("onlyWithKnownTime",function(onlyWithKnownTime){$scope.filter.onlyWithKnownTime=onlyWithKnownTime,$scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter),$cookieStore.put("onlyWithKnownTime",onlyWithKnownTime)}),$scope.$watch("lvlRangeSlider",function(lvlRange){$scope.filter.lvlRange=lvlRange,$scope.filteredCreatures=creaturesFilter.filter($scope.creatures,$scope.filter),$cookieStore.put("lvlRange.minValue",lvlRange.minValue),$cookieStore.put("lvlRange.maxValue",lvlRange.maxValue)},!0),$scope.$watch("creatures",function(creatures){creatures&&creatures.length>0})}]),angular.module("hideMenu",[]).directive("hideMenu",function(){return{scope:{opened:"=hideMenu"},link:function($scope,element){element.bind("click",function(){event.pageX>99&&$scope.$apply(function(){$scope.opened=!1})})}}}),angular.module("login",["dataSource","ngEnter","userAuthService","controls.hcValidationPattern"]).controller("loginCtrl",["$scope","$rootScope","dataSource","$http","userAuthService","appStates","$state","notificationService","$stateParams",function($scope,$rootScope,dataSource,$http,userAuthService,appStates,$state,notificationService,$stateParams){$rootScope.showLogout=!1,$scope.logg=function(login,password){userAuthService.loggIn(login,password).then(function(){$rootScope.states=appStates[!0],userAuthService.setLogged(!0),$state.go(""!==$stateParams.destinationState?$stateParams.destinationState:$rootScope.states[0].reference,$stateParams.destinationParams)})},$scope.showNotification=function(){notificationService.showSuccessNotification("wiadomosc")}}]),angular.module("profile",["dataSource","controls.hcUserHeroTile"]).controller("profileCtrl",["$scope","$rootScope","dataSource","$location","$stateParams","defaultAvatar",function($scope,$rootScope,dataSource,$location,$stateParams,defaultAvatar){console.log("profileCtrl"),$scope.defaultAvatarLink=defaultAvatar.link,$stateParams.userId&&dataSource.getUserProfile($stateParams.userId).then(function(data){$scope.userProfileModel=data})}]),angular.module("register",["dataSource","ngEnter"]).controller("registerCtrl",["$scope","$rootScope","dataSource","$http","userAuthService","$state",function($scope,$rootScope,dataSource,$http,userAuthService,$state){$scope.register=function(registerData){userAuthService.register(registerData).then(function(){$state.go("login")}).then(null,function(error){$scope.registerMessage=error.message})}}]),angular.module("settings",["dataSource","ngFileUpload","ngImgCrop"]).controller("settingsCtrl",["$scope","$rootScope","dataSource","avatarService","notificationService","defaultAvatar",function($scope,$rootScope,dataSource,avatarService,notificationService,defaultAvatar){var setDefaultSettingsValues=function(){$scope.editPasswordSettings=null,$scope.editContactSettings=null,$scope.editEmailSettings=null,$scope.editAvatar=null,$scope.croppedImg=null,$scope.loadedImg=null,$scope.passwordModel={},$scope.emailModel={}},counter=0;$scope.defaultAvatarLink=defaultAvatar.link,$rootScope.$on("dataSource.ready",function(){counter++,$scope.model=$rootScope.model,1===counter&&$rootScope.model.personalData.isAdministrator,console.log("settings datasource ready",counter),setDefaultSettingsValues()
});var createSettingsCheckpoint=function(data){var savedSettings={gg:data.gg,ggVisible:data.ggVisible,phone:data.phone,phoneVisible:data.phoneVisible,name:data.name};return savedSettings},settingsCheckpoint={};$scope.uploadAvatar=function(){dataSource.changeAvatar($rootScope.model.personalData.id,$scope.croppedImg)},$scope.cancelUploadAvatar=function(){$scope.croppedImg=null,$scope.editAvatar=!1,$scope.loadedImg=null},$scope.changeContactSettings=function(){$scope.editContactSettings=!0,settingsCheckpoint=createSettingsCheckpoint($scope.model.personalData)};var restoreSettingsCheckpoint=function(){var personalData=$scope.model.personalData;personalData.gg=settingsCheckpoint.gg,personalData.ggVisible=settingsCheckpoint.ggVisible,personalData.phonw=settingsCheckpoint.phone,personalData.phoneVisible=settingsCheckpoint.phoneVisible,personalData.name=settingsCheckpoint.name};$scope.applyContactSettings=function(){var contactSettingsPromise=dataSource.applyContactSettings($scope.model.personalData);contactSettingsPromise.then(function(data){$scope.editContactSettings=!1,settingsCheckpoint=createSettingsCheckpoint(data),notificationService.showSuccessNotification("Contact settings succesfully changed")})},$scope.cancelContactSettings=function(){$scope.editContactSettings=!1,restoreSettingsCheckpoint()},$scope.cancelChangeEmail=function(){$scope.editEmailSettings=!1},$scope.changeEmail=function(changeEmailForm){var changeEmailPromise=dataSource.changeEmail($rootScope.model.personalData,changeEmailForm.oldEmail,changeEmailForm.newEmail);changeEmailPromise.then(function(data){$scope.editEmailSettings=!1,notificationService.showSuccessNotification("Successfully change your email address to "+data.email)})},$scope.readFileImg=function(files){$scope.loadedImg=null,$scope.success=null,files&&files.length&&avatarService.readImageFile(files[0]).then(function(img){$scope.loadedImg=img})},$scope.changePassword=function(changePasswordForm){var changePasswordPromise=dataSource.changePassword($rootScope.model.personalData,changePasswordForm.oldPassword,changePasswordForm.newPassword);changePasswordPromise.then(function(){$scope.editPasswordSettings=!1,notificationService.showSuccessNotification("Successfully change your password")})},$scope.cancelChangePassword=function(){$scope.editPasswordSettings=!1}}]),angular.module("userManager",["dataSource","ngEnter"]).controller("userManagerCtrl",["$scope","$rootScope","dataSource","notificationService","defaultAvatar",function($scope,$rootScope,dataSource,notificationService,defaultAvatar){$scope.defaultAvatarLink=defaultAvatar.link,$scope.filterConfig={field:"name",reverse:!1},$scope.reverse=$rootScope.$on("dataSource.ready",function(){$scope.users=$rootScope.model.users,$scope.users&&$scope.users.length>0&&($scope.activeUserId=$scope.users[0].id)}),$rootScope.model.personalData&&$rootScope.model.personalData.isAdministrator&&dataSource.getUsers(),$scope.setFilter=function(field){$scope.filterConfig.field=field,field===$scope.filterConfig.field&&($scope.filterConfig.reverse=!$scope.filterConfig.reverse)},$scope.openDetails=function(user){null!==user.waitForAccept&&($scope.activeUserId=user.id)},$scope.acceptUser=function(user){var acceptUserPromise=dataSource.acceptUserActivation(user);acceptUserPromise.then(function(){notificationService.showSuccessNotification("user "+user.name+" successfully accepted")})},$scope.rejectUser=function(user){var rejectUserPromise=dataSource.rejectUserActivation(user);rejectUserPromise.then(function(){notificationService.showSuccessNotification("user "+user.name+" successfully rejected")})},$scope.setAdministrator=function(user){var setAdministratorPromise=dataSource.setAdministrator(user);setAdministratorPromise.then(function(){notificationService.showSuccessNotification("user "+user.name+" was successfully grant to administrator")})},$scope.setCommonUser=function(user){var setCommonUserPromise=dataSource.setCommonUser(user);setCommonUserPromise.then(function(){notificationService.showSuccessNotification("user "+user.name+" was successfully grant to standard user")})}}]);